#!/bin/bash
#
# A custom session script for `systemd --user` and a WM.

SESSION_APPLICATION=awesome

# Read environment from `systemd --user`.
echo "Reading \`systemd --user\` environment"

while IFS="=" read name value; do
	eval "test \$$name || export $name='$value'"
done < <(systemctl --user show-environment)


# Run the `systemd --user` session.
systemd_suffix="@${DISPLAY}"
systemd_envfile="$XDG_RUNTIME_DIR/$DISPLAY-environment"
systemd_target="graphic${systemd_suffix}.target"
systemd_exit_target="exit-session${systemd_suffix}.target"

echo "Starting \`systemd --user\` unit $systemd_target"

printenv > "$systemd_envfile"
systemctl --user isolate "$systemd_target"


function stop_systemd_session() {
	# Stop the `systemd --user` session.
	echo "Stopping \`systemd --user\` session"

	systemctl --user start "$systemd_exit_target"
	rm -f "$systemd_envfile"
	echo "Session wrapper done"
}

trap stop_systemd_session EXIT TERM HUP


# Run the session itself.
echo "Starting session application '${SESSION_APPLICATION[@]}'"

"${SESSION_APPLICATION[@]}"

echo "Session application exited"
